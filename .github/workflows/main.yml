name: Check Reminders

on:
  workflow_dispatch:
  schedule:
    - cron: "*/1 * * * *"

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Download Google Sheet CSV
        run: |
          curl -L "https://docs.google.com/spreadsheets/d/14PZSvCBH4FXnrlWBZPZnikOy_IInoTbgrhEtZ1dfSUs/export?format=csv&gid=2122564761" -o reminders.csv

      - name: Send LINE reminders
        env:
          USER_ID: ${{ secrets.USER_ID }}
          TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        run: |
          NOW_TS=$(TZ=Asia/Taipei date +%s)
          PREV_TS=$((NOW_TS-60))

          echo "Now TS: $NOW_TS"
          echo "Prev TS: $PREV_TS"
          echo "===== CSV ====="
          cat reminders.csv

          tail -n +2 reminders.csv | sed '1s/^\xEF\xBB\xBF//' | while IFS=, read timestamp pet message time; do

            TIME_STR=$(echo "$time" | tr -d '" ')
            PET=$(echo "$pet" | tr -d '" ')
            MSG=$(echo "$message" | tr -d '" ')

            # è½‰æ™‚é–“æˆ³
            TIME_TS=$(TZ=Asia/Taipei date -d "$TIME_STR" +%s 2>/dev/null)

            echo "Row â†’ PET=[$PET] MSG=[$MSG] TIME=[$TIME_STR] TS=$TIME_TS"

            if [ -n "$TIME_TS" ] && [ "$TIME_TS" -gt "$PREV_TS" ] && [ "$TIME_TS" -le "$NOW_TS" ]; then
              echo ">>> MATCH â€” Sending LINE"

              curl -i -X POST https://api.line.me/v2/bot/message/push \
                -H "Authorization: Bearer $TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"to\":\"$USER_ID\",\"messages\":[{\"type\":\"text\",\"text\":\"ğŸ¾ æé†’ä½ ï¼š$PET $MSG\"}]}"
            fi

          done
