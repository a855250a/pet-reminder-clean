name: Check Reminders

on:
  workflow_dispatch:
  schedule:
    - cron: "*/1 * * * *"

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Download Google Sheet CSV
        run: |
          curl -L "https://docs.google.com/spreadsheets/d/14PZSvCBH4FXnrlWBZPZnikOy_IInoTbgrhEtZ1dfSUs/export?format=csv&gid=2122564761" -o reminders.csv

      - name: Show CSV (debug)
        run: |
          echo "===== CSV ====="
          cat reminders.csv
          echo "==============="

      - name: Send LINE reminders
        env:
          USER_ID: ${{ secrets.USER_ID }}
          TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        run: |
          NOW=$(TZ=Asia/Taipei date +"%Y-%m-%d %H:%M")
          PREV=$(TZ=Asia/Taipei date -d "$NOW - 1 minute" +"%Y-%m-%d %H:%M")

          echo "Now: $NOW"
          echo "Prev: $PREV"

          tail -n +2 reminders.csv | sed '1s/^\xEF\xBB\xBF//' | while IFS=, read timestamp pet message time; do

            TIME=$(echo "$time" | tr -d '" ')
            PET=$(echo "$pet" | tr -d '" ')
            MSG=$(echo "$message" | tr -d '" ')

            echo "Row â†’ PET=[$PET] MSG=[$MSG] TIME=[$TIME]"

            # æŠ“ 1 åˆ†é˜ç¯„åœå…§
            if [[ "$TIME" > "$PREV" && "$TIME" <= "$NOW" ]]; then
              echo ">>> MATCH â€” Sending LINE notification"

              curl -i -X POST https://api.line.me/v2/bot/message/push \
                -H "Authorization: Bearer $TOKEN" \
                -H "Content-Type: application/json" \
                -d "{\"to\":\"$USER_ID\",\"messages\":[{\"type\":\"text\",\"text\":\"ğŸ¾ æé†’ä½ ï¼š$PET $MSG\"}]}"
            fi

          done
